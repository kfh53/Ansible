---
- name: Atlassian Tool Setup
  hosts: atlassian
  gather_facts: yes
  vars:
    - mysql_ip: 192.168.1.194
    - mysql_port: 3306
    - bamboo_port: 8085
    - bitbucket_port: 7990
    - confluence_port: 8090
    - crowd_port: 8095
    - jira_port: 8080
    - confluence_driver_dir: /opt/atlassian/confluence/confluence/WEB-INF/lib/
    - jira_driver_dir: /opt/atlassian/jira/lib/
    - vol_dir: /root/Ansible/Atlassian/vols/
    - home_dir: /var/atlassian/application-data/
  tasks: 
  - name: Download Dependencies
    apt:
      name: "{{ packages }}"
      state: latest
      update_cache: yes
    loop:
      - docker
      - python3-pip
    loop_control:
      loop_var: packages
  - name: Install docker-py
    pip:
      name: docker-py
  - name: Start Docker 
    service: 
      name: docker
      state: started
  - name: Pull Atlassian images
    docker_image:
      name: "{{ docker_images }}"
      source: pull
    loop:
      - mysql
      - atlassian/jira-software
      - atlassian/confluence-server
      - atlassian/bamboo-server
      - atlassian/bitbucket-server
      - atlassian/crowd
      - atlassian/stash
    loop_control:
      loop_var: docker_images
  - name: Create Containers
    include: "{{ containers }}"
    loop: 
      - roles/mysql/main.yml
      - roles/jira/main.yml
      - roles/confluence/main.yml
      - roles/bamboo/main.yml
      - roles/bitbucket/main.yml
      - roles/crowd/main.yml
    loop_control:
      loop_var: containers